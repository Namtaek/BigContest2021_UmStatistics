## 2021 빅콘테스트 데이터분석분야 ECO제주 참가팀 UmStatistics

2021 빅콘테스트 데이터분석분야 퓨처스리그 ECO제주 부문 **제주특별자치도지사상(대상)** 수상작입니다.

## Overview

![image](https://user-images.githubusercontent.com/63837766/147443395-8157db8d-1093-474a-944c-6006b358d28b.png)

### 데이터 전처리

1. 결측치/이상치 파악
  - 현재 문제는 41개 행정동의 월별 배출량을 예측하는 것이다. 행정동 안에는 관측지점이 다수 존재하는데, 관측지점별로 결측치가 매우 많다.
  - 한 행정동의 1)다수의 결측지점에서 2)결측이 동일한 패턴으로 3)연속적인 기간동안 발생했다.
  - 더불어 이런 결측의 패턴은 인접한 행정동별로 유사하다.
  - 해당 원인은 기사를 통해 찾을 수 있었는데, 서귀포시는 장비교체에 따른 결측, 제주시는 읍면지역으로 확대하면서 생긴 결측이었다.

![image](https://user-images.githubusercontent.com/63837766/147443405-2dbf0b48-353b-49ea-91dd-b912ee82e18e.png)

2. 이상치 대체
  - 해당 결측치를 행정동별로 보게 되면 이상치가 된다. 이상치를 행정동 별로 대체한다.
  - 기존에 선형보간/스플라인보간/지수평활/칼만필터 등등의 다양한 대체 방법을 사용함.
  - 이것보다는 기존에 관측한 계절성(7일/반년/일년)을 기반, sin-cos(조화)회귀를 통해 패턴추정 후 데이터 생성
  - 월별로 스플라인보간 등의 방법을 사용하는 것보다 이상치 지점을 잘 채워줌

3. 변수간의 관계 파악
  - 기존의 변수간의 상관만 볼 경우 관계가 왜곡되는 것을 파악
  - 변수간의 (인과)그래프 구조를 고려하기 위해 베이지안 네트워크 도입
  - 변수간의 시차를 고려하기 위해 그레인저 검정 시행
  - 교란을 보정하고 시차를 고려해서 관계를 파악

4. 모델링에 이용할 파생변수 생성
  - 계절성을 고려하기 위해 sin-cos 변수 생성
  - 공간을 고려하기 위해 위경도 변수 생성
  - 1년전/35일/63일 전 배출량이 현재 배출량과 상관이 높기 때문에 변수로 생성

### 모델링

1. 모델링의 목표

![image](https://user-images.githubusercontent.com/63837766/147443408-f0c9cc9b-792c-45aa-8500-c2d8486ea0ce.png)

  - 1)모든 기간을 잘 맞추고, 2)사후해석, 3)시공간 자기상관 고려
  - 시계열성을 고려한 train/test 분리 및 롤링윈도우 방식으로 CV
  - 예측력의 극대화를 위해 1달/2달 뒤를 각각 예측하는 모델로 이분화

2. 월별 모델링
  - ARIMA : 시간자기상관 모델링
  - GWR : 공간자기상관 모델링 (시간변수를 추가적으로 고려)

3. 일별 모델링
  - 일별데이터는 많은 관측치와 외부변수 존재
  - 복잡한 관계를 학습/정보량이 적은 변수에 강건/시공간 정보를 변수를 통해 학습
  - LightGBM : SHAP을 통한 사후해석
  - BART : Feature Importance/PDP를 통한 사후해석

4. 앙상블
  - 3~6월의 RMSE를 기준으로 비율 선정

### 정책제안

1. 현황관리 : 이상치탐지
  - 데이터에 이상치가 매우 많음
  - 이상치를 조기에 관측하고 관리할 수 있다면 데이터의 품질 향상 가능
  - 실무자들이 이를 어렵지 않게 활용할 수 있도록 클릭 형태로 구현
  - 실데이터에서 시험할 경우 잘 작동하는 것을 확인
  
2. 사전관리 : 배달/대형마트 정책
  - 음식물을 구매하는 시점에 대한 정책의 필요성
  - 배달/대형마트에서 발생하는 쓰레기를 줄이기 위한 정책 제안
  - 해당 정책의 인과적 효과를 계량하기 위한 정책 디자인을 동시에 제안
  - 이중차분법의 가정을 만족시켜줌

![image](https://user-images.githubusercontent.com/63837766/147443407-093b9da1-94cb-4f16-9eb3-c6a62498b193.png)

3. 사후관리 : 감량화기 시범도입
  - 음식물이 배출된 이후 이를 감량하기 위한 정책
  - 현재 데이터의 부재로 시뮬레이션을 통해 입지 선정
  - 많은 비용이 드는 사업인만큼 데이터 기반의 정책이 필요


## 발표 PPT

**추후 업로드 예정**
  - PSAT 카페 업로드(예정)
  - 필요하다면 메일 부탁드립니다.

## 파일 구성

1. 결과보고서 : ~~데이터분석분야_퓨처스리그_ECO제주_UmStatistics_결과보고서.pdf~~
2. 평가데이터 : 데이터분석분야_퓨처스리그_ECO제주_UmStatistics_평가데이터.xlsx


3. 추가제출파일(Additional_Submission_Files, 경로에 한글파일을 두지 않기위해 설정했습니다.)  

	- data폴더 : **메인 데이터는 깃헙에 올리지 않았습니다.**
	  - ~~기존의 제공된 데이터 파일들을 여기에 넣어주시면 됩니다. 외부데이터 + 모델링 용 데이터 + Arima모델 최적의 pdq 등~~
	
	- code : 각각 .R/.Rmd/.html 파일로 구성되어 있습니다.
	    - 1.Preprocess.R/.Rmd/.html : 전처리
	    - 2.Modeling.R./.Rmd/.html : `Arima`/`GWR`/`LightGBM`/`BART` 모델링과 예측 
	    - 3.Proposal.R/.Rmd/.html : 정책제안과 관련한 데이터분석 결과
	    - 4.Visualiztion.R/.Rmd/.html : PPT에 담기는 시각화 결과들 재현

	- lightgbm_model : 'R Session Aborted'의 경우, 폴더에서 lightgbm 모델 불러와서 예측
			 실제 결과를 재현 가능.

	- shiny : 이상치탐지 shiny 구현 코드와 코드 실행을 위한 데이터/사진 파일
		 

4. README.txt : 파일 구성과 관련한 설명자료

## 코드실행 유의사항

1. 기존 제공데이터들을 'data' 폴더에 위치시켜 주시기 바랍니다.

2. 워킹디렉토리는 자동적으로 설정되도록 해놓았습니다. 
    다만 기존데이터 파일명이 현재 코드에 설정된 것과 다를 수 있으니 확인 부탁드립니다.

3. 패키지 또한 자동적으로 설치될 수 있도록 코드를 삽입해놓았습니다.

4. 일부 Randomness가 들어가는 부분들에 대해서는 `set.seed()`를 통해 이를 통제해주었습니다. 
    R버전 4.0 이상에서는 다른 환경이더라도 seed가 같다면 결과가 재현됩니다.

5. LightGBM 모델링 과정에서 'R Session Aborted'가 발생할 수 있습니다.
   해당 문제가 발생할 경우, 모델링을 위한 RAM 공간을 충분히 확보해주시기 바랍니다.

   5-1. 만일 RAM 공간이 충분히 확보된 상황에서 해당 문제가 발생한다면,
         주석처리되어있는 부분을 해제하고, 첨부된 LGBM 모델 파일을 불러와서 예측을 진행해주시기 바랍니다.

   5-2. 혹은 .Rmd 파일에서 재현심사를 진행해주시기 바랍니다.
          .Rmd 파일은 'R Session Aborted' 이슈가 없습니다. 

6. 패키지 버전상의 문제로 'tidyverse' 패키지의 'summarize' 함수 뒤에 'ungroup' 함수를 사용하지 않으면 문제가 발생하는 경우들이 있습니다.
   코드 정리시 이를 확인하였으나, 혹시 오류가 생긴다면 'ungroup'함수를 붙여주는 것으로 디버깅이 가능합니다.

7. shiny 폴더에 있는 'app', 'www', 'dong_fw'는 동일한 폴더에 존재해야 작동합니다. 
   결과확인을 위한 실행은 8.을 확인해주시기 바랍니다.

8. shiny app의 결과는 '3.Proposal'의 마지막 줄의 'runGithub' 코드를 실행하면 됩니다.

## 로컬환경

- CPU : Intel(R) Core(TM) i7-10750H CPU @ 2.60GHz   2.59 GHz
- RAM : 16.0GB
- GPU : No GPU Computing

## R 환경

- R 버전 : 4.0.2
  - tidyverse : 1.3.0
  - data.table : 1.13.0
  - lubridate : 1.7.10
  - imputeTS : 3.2
  - forecast : 8.13
  - spgwr : 0.6-34
  - lightgbm : 3.1.0
  - BayesTree : 0.3-1.4
  - cluster : 2.1.0
  - factoextra : 1.0.7
  - gridExtra : 2.3
  - BiocManager : 1.30.16
  - Rgraphviz : 2.34.0
  - SHAPforxgboost : 0.1.1
  - bnlearn : 4.6.1
  - visNetwork : 2.0.9

